* [**Auditing**](#)

# Auditing

Modifications in database records are logged to the **activity_log** table. This table is generated by the package [ActivityLog](https://github.com/spatie/laravel-activitylog). The activities are shown in a 'History' link provided in the Show.view of the models.
1. The package stores changes as json in the `properties` field, which contains two elements: `attributes`  and `old`, which are basically the new vs old values that have been changed. This structure must be respected.
1. Class **ActivityFunctions** contain custom functions to read the the properties Json record stored in the `activity_log` table and finds the values to show in the History datatable;
1. Most changes are logged by the package as `trait` called within the Class. These allow to automatically log most updates and are all configured to log only the fields that have changed, not entire records (option `dirty`). Also record creation are not logged as activity, only changes.
1. Some changes, like Plant and Vouchers collectors and identifications are manually logged, as they involve Pivot tables and logging is specified in the Controller files;
1. Logging contain a `log_name` field that groups log types and used to distinguish types of activity and usefull to search the History Datatable;
1. Two special logging are also done:
  1. Any Dataset download is logged, so administrators may track who and when the dataset was downloaded;
  1. Any Dataset request is also logged for the same reason

**The `clean-command` of the package SHOULD NOT be used during production, otherwise will just erase all logged changes**. If run, will erase the logs older than the time specified in the `/config/activitylog.php` file.

<br>
The ActivityLog table has the following structure:

![](https://github.com/opendatabio/datamodel/blob/master/auditing_model.png)
<img src="{{ asset('images/docs/auditing_model.png') }}" alt="Auditing model" with=350>


*  `causer_type` and `causer_id`  will be the [User](Data-Access-Objects#users) that made the change
*  `subject_type` and `subject_id` will the model and record changed
*  `log_name` - to group logs together and permits queries
*  `description` - somewhat redundant with log_name in a OpenDataBio context.
*  `properties` - stores the changes, for example, and identification change will have a log like:


```JSON
{
    "attributes":
    {
        "person_id":"2",
        "taxon_id":"1424",
        "modifier":"2",
        "herbarium_id":"1",
        "herbarium_reference":"1234",
        "notes":"A new fake note has been inserted",
        "date":"2020-02-08"},
    "old":{
        "person_id":674,
        "taxon_id":1413,
        "date":"1995-00-00",
        "modifier":0,
        "herbarium_id":null,
        "notes":null,
        "herbarium_reference":null
    }
}

```
